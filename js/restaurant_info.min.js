let restaurant;var map;const dbPromise=idb.open("restaurant-store",1,function(e){e.objectStoreNames.contains("restaurantsObj")||console.log("There is no IndexDB"),e.objectStoreNames.contains("reviewsObj")||e.createObjectStore("reviewsObj",{keyPath:"id"})});window.initMap=(()=>{fetchRestaurantFromURL((e,t)=>{e?console.error(e):(self.map=new google.maps.Map(document.getElementById("map"),{zoom:16,center:t.latlng,scrollwheel:!1}),fillBreadcrumb(),DBHelper.mapMarkerForRestaurant(self.restaurant,self.map))})}),fetchRestaurantFromURL=(e=>{if(self.restaurant)return void e(null,self.restaurant);const t=getParameterByName("id");t?DBHelper.fetchRestaurantById(t,(t,n)=>{self.restaurant=n,n?(fillRestaurantHTML(),e(null,n)):console.error(t)}):(error="No restaurant id in URL",e(error,null))}),fillRestaurantHTML=((e=self.restaurant)=>{document.getElementById("restaurant-name").innerHTML=e.name,document.getElementById("restaurant-address").innerHTML=e.address;const t=document.getElementById("restaurant-img");t.className="restaurant-img";const n=`/img/small_img/${e.id}_small.jpg 360w, /img/medium_img/${e.id}_med.jpg 600w`;t.setAttribute("srcset",n),t.setAttribute("sizes","(max-width: 750px) 100vw,(min-width: 751px) 25vw"),t.src=DBHelper.imageUrlForRestaurant(e),t.alt=`image of restaurant ${e.name}`,document.getElementById("restaurant-cuisine").innerHTML=e.cuisine_type,e.operating_hours&&fillRestaurantHoursHTML(),fillReviewsHTML()}),fillRestaurantHoursHTML=((e=self.restaurant.operating_hours)=>{const t=document.getElementById("restaurant-hours");for(let n in e){const r=document.createElement("tr"),a=document.createElement("td");a.innerHTML=n,r.appendChild(a);const o=document.createElement("td");o.innerHTML=e[n],r.appendChild(o),t.appendChild(r)}}),fillReviewsHTML=(()=>{const e=document.getElementById("reviews-container"),t=document.createElement("h3"),n=document.createElement("button");n.innerHTML="Write your review",n.style.backgroundColor="red",n.style.color="white",n.onclick=(e=>{e.preventDefault(),modal.style.display="block"}),t.appendChild(n),e.appendChild(t);const r=document.getElementById("reviews-list");dbPromise.then(e=>{const t=e.transaction("reviewsObj","readonly");t.objectStore("reviewsObj").openCursor().then(function e(t){if(!t)return;const n=t.value;return n.restaurant_id===myID&&r.appendChild(createReviewHTML(n)),t.continue().then(e)}),t.complete.then(()=>console.log("finished"))}),e.appendChild(r)}),createReviewHTML=(e=>{const t=document.createElement("li"),n=document.createElement("p");n.innerHTML=e.name,t.appendChild(n);const r=document.createElement("p");r.innerHTML=new Date(e.createdAt),t.appendChild(r);const a=document.createElement("p");a.innerHTML=`Rating: ${e.rating}`,t.appendChild(a);const o=document.createElement("p");return o.innerHTML=e.comments,t.appendChild(o),t}),fillBreadcrumb=((e=self.restaurant)=>{const t=document.getElementById("breadcrumb"),n=document.createElement("li");n.innerHTML=e.name,t.appendChild(n)}),getParameterByName=((e,t)=>{t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");const n=new RegExp(`[?&]${e}(=([^&#]*)|&|#|$)`).exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null});const myID=Number(getParameterByName("id")),favStar=document.getElementById("fav-star"),textFav=document.getElementById("par-fav-star"),endpointFav=`http://localhost:1337/restaurants/${myID}/?is_favorite=true`,endpointUnFav=`http://localhost:1337/restaurants/${myID}/?is_favorite=false`,updateStar=()=>{DBHelper.fetchRestaurantById(myID,(e,t)=>{let n;(n="true"===t.is_favorite)?(favStar.style.color="red",textFav.innerHTML=""):(favStar.style.color="black",textFav.innerText="Mark as favorite")})};updateStar(),favStar.addEventListener("click",()=>{dbPromise.then(e=>{const t=e.transaction("restaurantsObj","readwrite"),n=t.objectStore("restaurantsObj");let r=IDBKeyRange.only(myID);n.openCursor(r).then(function e(t){if(t){if(t.value.id===myID){const e=t.value;e.is_favorite?("true"===e.is_favorite?(e.is_favorite="false",fetch(endpointUnFav,{method:"POST"})):(e.is_favorite="true",fetch(endpointFav,{method:"POST"})),t.update(e)):(console.log("Missing"),e.is_favorite="true",t.update(e))}return t.continue().then(e)}}),t.complete.then(()=>console.log("finished"))}),updateStar()});const close=document.getElementById("close"),modal=document.getElementById("modal"),submit=document.getElementById("submit"),formName=document.querySelector("#reviewer_name"),formComments=document.querySelector("#comments"),formRating=document.querySelector("#rating");close.addEventListener("click",e=>{e.preventDefault(),modal.style.display="none"}),submit.addEventListener("click",e=>{e.preventDefault(),""!==formComments.value.trim()&&""!==formRating.value.trim()&&""!==formName.value.trim()?(modal.style.display="none","serviceWorker"in navigator&&"SyncManager"in window&&navigator.serviceWorker.ready.then(e=>{const t={id:(new Date).toISOString(),restaurant_id:myID,name:formName.value,rating:formRating.value,comments:formComments.value,createdAt:(new Date).toDateString(),fromForm:!0};console.log(t),dbPromise.then(e=>{const n=e.transaction("reviewsObj","readwrite");return n.objectStore("reviewsObj").put(t),n.complete}).then(()=>{e.sync.register("sync-new-comment");const t=document.getElementById("reviews-container"),n=document.getElementById("reviews-list");n.innerHTML="",dbPromise.then(e=>{const t=e.transaction("reviewsObj","readonly");t.objectStore("reviewsObj").openCursor().then(function e(t){if(!t)return;const r=t.value;return r.restaurant_id===myID&&n.appendChild(createReviewHTML(r)),t.continue().then(e)}),t.complete.then(()=>console.log("finished"))}),t.appendChild(n)})})):alert("Please, fill all the fields")});